name: Tests
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.7, 3.8, 3.9]
        plone-version: ["6.0.0a1", "5.2.6"]
        exclude:
          - plone-version: "5.2.6"
            python-version: 3.9

    steps:
      # git checkout
      - uses: actions/checkout@v2

      # python setup
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      # python cache
      - name: Setup cache
        id: cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ matrix.plone-version }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      # python install
      - name: Create virtual environment
        run: |
          python -m venv .
          ./bin/pip install -U pip setuptools wheel

      # Plone install
      - name: Install Plone
        run: |
          ./bin/pip install Plone -c https://dist.plone.org/release/${{ matrix.plone-version }}/constraints.txt  --use-deprecated legacy-resolver

      # Install plone.volto with test extras
      - name: Install plone.volto
        run: |
          ./bin/pip install ".[test]" --use-deprecated legacy-resolver

      # test
      - name: test
        run: |
          ./bin/zope-testrunner --auto-color --auto-progress --test-path src
